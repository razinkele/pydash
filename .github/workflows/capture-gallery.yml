name: Capture Gallery Screenshots

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 6 * * 1'  # weekly on Mondays at 06:00 UTC (optional)

permissions:
  contents: read

jobs:
  capture:
    name: Capture screenshots and upload artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install playwright Pillow

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps

      - name: Capture screenshots
        run: |
          mkdir -p docs/images
          python scripts/capture_gallery_screenshots.py --examples examples/mvp_shiny.py --out docs/images

      - name: List generated images
        run: ls -la docs/images || true

      - name: Upload screenshots and thumbnails
        uses: actions/upload-artifact@v4
        with:
          name: gallery-images
          path: |
            docs/images/**

      - name: Optional: Commit images to main (requires PAT)
        if: ${{ secrets.GALLERY_PUSH_TOKEN != '' }}
        run: |
          echo "GALLERY_PUSH_TOKEN provided but commit step is currently simplified in CI. If you want CI to push images, replace this placeholder with the commit logic or set up the PAT and re-enable the step."

      - name: Done
        run: echo "Gallery capture job completed. Artifacts uploaded as 'gallery-images'."
