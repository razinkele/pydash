name: Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Build and conditionally publish to PyPI
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          python -m build
          if [ -z "${PYPI_API_TOKEN}" ]; then
            echo "PYPI_API_TOKEN not set; skipping publish to PyPI (create repo secret to enable)"
            exit 0
          fi
          # publish using token stored in PYPI_API_TOKEN
          python -m twine upload dist/* -u __token__ -p "${PYPI_API_TOKEN}"
      - name: Get release notes
        id: get_notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Try to get annotated tag message
          NOTES=$(git tag -l --format='%(contents)' "$TAG")
          # Fallback: try to extract a section from CHANGELOG.md (## <tag>)
          if [ -z "$NOTES" ] && [ -f CHANGELOG.md ]; then
            NOTES=$(awk "/^##[[:space:]]*${TAG}/{flag=1;next}/^##[[:space:]]/{flag=0}flag" CHANGELOG.md)
          fi
          if [ -z "$NOTES" ]; then NOTES="Published via CI for ${TAG}"; fi
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish GitHub Release (un-draft)
        if: env.PYPI_API_TOKEN != ''
        uses: actions/github-script@v7
        with:
          script: |
            const tag = process.env.GITHUB_REF.replace('refs/tags/','');
            const notes = `${{ steps.get_notes.outputs.notes }}`;
            // Find an existing release for the tag
            const releases = await github.rest.repos.listReleases({ owner: context.repo.owner, repo: context.repo.repo });
            const rel = releases.data.find(r => r.tag_name === tag);
            if (rel) {
              await github.rest.repos.updateRelease({ owner: context.repo.owner, repo: context.repo.repo, release_id: rel.id, draft: false, body: notes });
              core.info(`Published existing release for tag ${tag} (id=${rel.id})`);
            } else {
              await github.rest.repos.createRelease({ owner: context.repo.owner, repo: context.repo.repo, tag_name: tag, name: tag, body: notes, draft: false });
              core.info(`Created and published new release for tag ${tag}`);
            }
