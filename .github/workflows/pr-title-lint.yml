name: PR Title Lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: read

jobs:
  lint-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title follows Conventional Commits and optionally auto-fix
        uses: actions/github-script@v7
        env:
          TITLE_BOT_TOKEN: ${{ secrets.TITLE_BOT_TOKEN }}
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('No pull request found in context.');
              return;
            }

            // Skip draft PRs
            if (pr.draft) {
              core.info('Draft PR — skipping title lint');
              return;
            }

            const title = (pr.title || '').trim();
            core.info(`PR title: ${title}`);

            // Allow merges and dependabot/autogenerated PRs
            if (/^(Merge |dependabot|bors\[bot\]|chore\(deps\):)/i.test(title)) {
              core.info('Merge / dependabot / deps PR — skipping title lint');
              return;
            }

            // Conventional Commit style: type(scope)?: description
            const cc_re = /^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\([^)]+\))?:\s+.+/i;

            if (cc_re.test(title)) {
              core.info('PR title passes Conventional Commits lint');
              return;
            }

            // Try to find a matching commit subject inside PR commits
            let suggested = null;
            try {
              const commits = await github.rest.pulls.listCommits({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number });
              for (const c of commits.data) {
                const subj = (c.commit && c.commit.message && c.commit.message.split('\n')[0]) || '';
                if (cc_re.test(subj)) { suggested = subj; break; }
              }
            } catch (e) {
              core.info('Could not list commits for PR: ' + e.message);
            }

            // Heuristic suggestion if no conventional commit found in commits
            if (!suggested) {
              const lower = title.toLowerCase();
              if (/\bfix(es|ed|ing)?\b|\bbug\b/.test(lower)) suggested = `fix: ${title}`;
              else if (/\bdoc(s|umentation)?\b/.test(lower)) suggested = `docs: ${title}`;
              else if (/\btest(s|ing)?\b/.test(lower)) suggested = `test: ${title}`;
              else if (/\brefactor\b/.test(lower)) suggested = `refactor: ${title}`;
              else if (/\bperf(ormance)?\b/.test(lower)) suggested = `perf: ${title}`;
              else suggested = `chore: ${title}`;
            }

            // If a TITLE_BOT_TOKEN is provided, attempt to update the PR title directly
            const botToken = process.env.TITLE_BOT_TOKEN;
            if (botToken) {
              try {
                const bot = github.getOctokit(botToken);
                await bot.rest.pulls.update({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, title: suggested });
                const body = `Hi @${pr.user.login}, I automatically updated the PR title to follow Conventional Commits:\n\n**New title:** \`${suggested}\`\n\nIf this is incorrect, please edit the title or revert.`;
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body });
                core.info(`Auto-updated PR title to: ${suggested}`);
                return; // success
              } catch (e) {
                core.info('Failed to auto-update PR title: ' + e.message);
                // fall through to posting suggestion
              }
            }

            // Post a suggestion comment and fail the check if we couldn't auto-fix
            const body = `Hi @${pr.user.login}, the PR title does not follow the Conventional Commits format.\n\n**Current title:** \`${title}\`\n**Suggested title:** \`${suggested}\`\n\nYou can update the title by clicking \"Edit\" next to the PR title. Example format: \`feat(scope): short description\`.\n\nIf this suggestion is incorrect, update the PR title to an appropriate Conventional Commit message.`;

            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body });

            core.setFailed(`PR title does not follow Conventional Commits format: "${title}". Suggested: "${suggested}". A comment has been posted on the PR to guide you.`);
