name: PR Title Lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: read

jobs:
  lint-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title follows Conventional Commits
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('No pull request found in context.');
              return;
            }

            // Skip draft PRs
            if (pr.draft) {
              core.info('Draft PR — skipping title lint');
              return;
            }

            const title = (pr.title || '').trim();
            core.info(`PR title: ${title}`);

            // Allow merges and dependabot/autogenerated PRs
            if (/^(Merge |dependabot|bors\[bot\]|chore\(deps\):)/i.test(title)) {
              core.info('Merge / dependabot / deps PR — skipping title lint');
              return;
            }

            // Conventional Commit style: type(scope)?: description
            const cc_re = /^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\([^)]+\))?:\s+.+/i;

            if (!cc_re.test(title)) {
              core.setFailed(`PR title does not follow Conventional Commits format: "${title}"\n\nPlease use: type(scope)?: short description, e.g. "feat(api): add new endpoint". Allowed types: feat, fix, docs, style, refactor, perf, test, chore, build, ci.`);
            } else {
              core.info('PR title passes Conventional Commits lint');
            }