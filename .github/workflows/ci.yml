name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
      - name: Skip python3.10 install (not needed on ubuntu-latest)
        if: ${{ matrix.python-version == '3.11' }}
        run: |
          echo "Skipping python3.10 install; pre-commit will run with the configured Python (3.11)."
      - name: Run pre-commit
        if: ${{ matrix.python-version == '3.11' }}
        run: pre-commit run --all-files
      - name: Lint (ruff)
        run: ruff check .
      - name: Format check (black)
        run: black --check .
      - name: Run tests
        run: pytest -q

  playwright-setup:
    runs-on: ubuntu-latest
    needs: test
    outputs:
      artifact-name: playwright-browsers
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-playwright-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Playwright and download browsers
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
          pip install playwright
          # Download browsers (cached in subsequent runs via artifact)
          playwright install --with-deps
      - name: Upload Playwright browsers artifact
        uses: actions/upload-artifact@v4
        with:
          name: playwright-browsers
          path: ~/.cache/ms-playwright

  shiny-tests:
    runs-on: ubuntu-latest
    needs: [test, playwright-setup]
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-shiny-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Shiny and dev deps
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
          pip install shiny
      - name: Download Playwright browsers artifact
        uses: actions/download-artifact@v3
        with:
          name: playwright-browsers
          path: playwright-browsers
      - name: Restore Playwright browsers to cache dir
        run: |
          mkdir -p ~/.cache/ms-playwright
          cp -r playwright-browsers/* ~/.cache/ms-playwright/
      - name: Install Playwright package
        run: |
          python -m pip install --upgrade pip
          pip install playwright
      - name: Run Shiny-dependent tests
        run: pytest -q tests/test_shiny_*.py tests/test_dashboard_page.py -q
      - name: Run Playwright smoke tests (Shiny app)
        run: pytest -q tests/test_visual_layout_smoke.py tests/test_visual_static_badges.py -q
      - name: Upload test artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: test-artifacts/**
      - name: Post PR comment with artifact links (on PRs)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const runId = process.env.GITHUB_RUN_ID;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: parseInt(runId) });
            let body = `⚠️ **Shiny smoke tests failed** — artifacts uploaded for diagnosis.\n\n`;
            if (artifacts.data && artifacts.data.artifacts && artifacts.data.artifacts.length > 0) {
              for (const a of artifacts.data.artifacts) {
                body += `- **${a.name}** — ${a.size_in_bytes} bytes\n`;
              }
              body += `\nYou can download artifacts from this run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${runId}\n\n`;
              body += "Tip: click the 'Artifacts' section on the run page and download the `test-artifacts` archive to retrieve logs, screenshots, HAR and traces.";
            } else {
              body += 'No artifacts were found for this run.';
            }
            const pr = context.payload.pull_request?.number;
            if (pr) {
              await github.rest.issues.createComment({ owner, repo, issue_number: pr, body });
            } else {
              console.log('Not a pull_request event; skipping PR comment.');
            }

  playwright:
    runs-on: ubuntu-latest
    needs: [test, playwright-setup]
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Download Playwright browsers artifact
        uses: actions/download-artifact@v3
        with:
          name: playwright-browsers
          path: playwright-browsers
      - name: Restore Playwright browsers to cache dir
        run: |
          mkdir -p ~/.cache/ms-playwright
          cp -r playwright-browsers/* ~/.cache/ms-playwright/
      - name: Install Playwright package
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
          pip install playwright
      - name: Run Playwright visual tests
        run: pytest -q tests/test_visual_*.py -q
      - name: Upload test artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: test-artifacts/**
      - name: Post PR comment with artifact links (on PRs)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const runId = process.env.GITHUB_RUN_ID;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id: parseInt(runId) });
            let body = `⚠️ **Playwright visual tests failed** — artifacts uploaded for diagnosis.\n\n`;
            if (artifacts.data && artifacts.data.artifacts && artifacts.data.artifacts.length > 0) {
              for (const a of artifacts.data.artifacts) {
                body += `- **${a.name}** — ${a.size_in_bytes} bytes\n`;
              }
              body += `\nYou can download artifacts from this run: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${runId}\n\n`;
              body += "Tip: click the 'Artifacts' section on the run page and download the `test-artifacts` archive to retrieve logs, screenshots, HAR and traces.";
            } else {
              body += 'No artifacts were found for this run.';
            }
            const pr = context.payload.pull_request?.number;
            if (pr) {
              await github.rest.issues.createComment({ owner, repo, issue_number: pr, body });
            } else {
              console.log('Not a pull_request event; skipping PR comment.');
            }

  packaging:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build
      - name: Build distributions
        run: python -m build
      - name: Verify asset in wheel
        run: |
          echo "Checking wheel for bs4dash_controlbar.js"
          if unzip -l dist/*.whl | grep -q "bs4dash_controlbar.js"; then
            echo "Asset found in wheel"
          else
            echo "ERROR: bs4dash_controlbar.js not found in wheel"; exit 1
          fi
      - name: Verify asset in sdist
        run: |
          echo "Checking sdist for bs4dash_controlbar.js"
          if tar -tzf dist/*.tar.gz | grep -q "bs4dash_controlbar.js"; then
            echo "Asset found in sdist"
          else
            echo "ERROR: bs4dash_controlbar.js not found in sdist"; exit 1
          fi
      - name: Run packaging tests
        run: |
          python -m pip install --upgrade pip
          pip install build pytest
          pytest -q tests/test_packaging_assets.py -q
      - name: Upload built distributions
        uses: actions/upload-artifact@v4
        with:
          name: distributions-${{ github.run_id }}
          path: dist/*

  release-validation:
    runs-on: ubuntu-latest
    # Run on pushes to main and on v* tag pushes
    if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e '.[dev]'
      - name: Run release validation tests
        run: pytest -q tests/test_release_tags.py tests/test_release_changelog.py -q
